workflow:
  name: "workflow-completion"
  title: "Completion"
  description: "Workflow to generate chat completion."
  context-variables:
    sdk-openai:
      api_key: "$TEMP_CONTEXT_VARIABLE_SDK_OPENAI_API_KEY"
  inputs:
    event_code: "$.get('event_code')"
    event_type: "$.get('event_type', 'content-snippet')"
    messages: "$.get('messages')"
    question: "$.get('question')"
  outputs:
    content: "$.get('content')"
    documents: "$.get('documents')"
    workflow-status: "$.get('content') is not None and 'executed' or 'failed'"
  tasks:
    - type: "document"
      name: "document-search"
      description: "Search documents"
      config:
        action: "search"
        threshold-docs: 15
        threshold-similarity: 0.01
        search-limit: 1000
        search-vector: true
      condition: "$.get('event_code') is None"
      connector:
        name: "sdk-openai"
        command: "invoke_embedding"
        model: "text-embedding-3-small"
      inputs:
        name: "$.get('event_type')"
        search-limit: "'10'"
        search-query: "$.get('question')"
      outputs:
        documents: "$.get('documents')"

    - type: "document"
      name: "document-search-by-event_code"
      description: "Search documents by event code"
      config:
        action: "search"
        threshold-docs: 15
        threshold-similarity: 0.01
        search-limit: 1000
        search-vector: true
      condition: "$.get('event_code') is not None"
      connector:
        name: "sdk-openai"
        command: "invoke_embedding"
        model: "text-embedding-3-small"
      inputs:
        name: "$.get('event_type')"
        metadata: |
          {
            "event_code": $.get('event_code')
          }
        search-limit: "'10'"
        search-query: "$.get('question')"
      outputs:
        documents: "$.get('documents')"

    - type: "prompt"
      name: "prompt-completion"
      description: "Chat Conversation."
      connector:
        name: "sdk-openai"
        command: "invoke_prompt"
        model: "gpt-4o"
      inputs:
        documents: "$.get('documents')"
        messages: "$.get('messages')"
        question: "$.get('question')"
      outputs:
        content: "$"

    - type: "document"
      name: "document-save"
      config:
        action: "save"
        embed-vector: true
      connector:
        name: "sdk-openai"
        command: "invoke_embedding"
        model: "text-embedding-3-small"
      documents:
        message: |
          {
            "question": $.get('question'),
            "content": $.get('content')
          }
